<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Radio â€” Now Playing</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
  <nav>
    <a class="logo" href="/">ðŸ“» Family Radio</a>
    <a href="/">Submit</a>
    <a href="/status.html" class="active">Now Playing</a>
    <a href="/admin.html">Admin</a>
  </nav>

  <div class="container" x-data="statusPage()" x-init="init()">
    <h1>Now Playing</h1>
    <p class="subtitle">
      Listen at <a :href="streamUrl" style="color:var(--accent)" target="_blank" x-text="streamUrl"></a>
      â€” open in VLC or any internet radio app.
    </p>

    <!-- Now Playing Card -->
    <div x-show="nowPlaying" class="now-playing" x-cloak>
      <div class="label">â™ª Now Playing</div>
      <div class="title" x-text="nowPlaying?.title"></div>
      <div class="artist" x-text="nowPlaying?.artist"></div>
      <div style="margin-top:0.5rem; font-size:0.8rem; color: var(--muted);">
        Submitted by <strong x-text="nowPlaying?.submitter"></strong>
      </div>
    </div>

    <div x-show="!nowPlaying && loaded" class="now-playing" x-cloak>
      <div class="label">Station</div>
      <div class="title">Starting upâ€¦</div>
      <div class="artist" style="color:var(--muted)">Nothing playing yet. Submit a song!</div>
    </div>

    <!-- Pending count -->
    <div x-show="pendingCount > 0" class="alert warning" x-cloak>
      <span x-text="pendingCount"></span> song(s) processing in the background.
    </div>

    <!-- Recent Tracks -->
    <div class="card" x-show="recent.length > 0" x-cloak>
      <h2>Recently Played</h2>
      <template x-for="track in recent" :key="track.id">
        <div class="track-item">
          <div class="track-meta">
            <div class="track-title" x-text="track.title"></div>
            <div class="track-sub">
              <span x-text="track.artist"></span> Â· by <span x-text="track.submitter"></span>
              Â· <span x-text="timeAgo(track.played_at)"></span>
            </div>
          </div>
        </div>
      </template>
    </div>

    <div x-show="recent.length === 0 && loaded" class="empty-state" x-cloak>
      No play history yet.
    </div>
  </div>

  <script>
    function statusPage() {
      return {
        nowPlaying: null,
        recent: [],
        pendingCount: 0,
        loaded: false,
        streamUrl: `${location.protocol}//${location.hostname}:8000/radio`,

        async init() {
          await this.refresh();
          setInterval(() => this.refresh(), 15000);
        },

        async refresh() {
          try {
            const res = await fetch('/api/status');
            const data = await res.json();
            this.nowPlaying = data.now_playing;
            this.recent = data.recent;
            this.pendingCount = data.pending_count;
            this.loaded = true;
          } catch (e) {
            console.error('Status fetch failed', e);
          }
        },

        timeAgo(isoStr) {
          const diff = (Date.now() - new Date(isoStr)) / 1000;
          if (diff < 60) return 'just now';
          if (diff < 3600) return `${Math.round(diff / 60)}m ago`;
          if (diff < 86400) return `${Math.round(diff / 3600)}h ago`;
          return `${Math.round(diff / 86400)}d ago`;
        }
      };
    }
  </script>
</body>
</html>
