services:
  icecast:
    image: moul/icecast
    restart: unless-stopped
    mem_limit: 100m
    volumes:
      - ./icecast/icecast.xml:/etc/icecast.xml:ro
    environment:
      - ICECAST_SOURCE_PASSWORD=${ICECAST_SOURCE_PASSWORD}
      - ICECAST_ADMIN_PASSWORD=${ICECAST_ADMIN_PASSWORD}
      - ICECAST_RELAY_PASSWORD=${ICECAST_RELAY_PASSWORD}
      - ICECAST_HOSTNAME=${SERVER_HOSTNAME}
      - STATION_NAME=${STATION_NAME}

  liquidsoap:
    build: ./liquidsoap
    restart: unless-stopped
    mem_limit: 400m
    depends_on:
      - icecast
      - api
    volumes:
      - media:/media
      - ./liquidsoap/radio.liq:/etc/liquidsoap/radio.liq:ro
    environment:
      - ICECAST_SOURCE_PASSWORD=${ICECAST_SOURCE_PASSWORD}
      - SERVER_HOSTNAME=${SERVER_HOSTNAME}
      - STATION_NAME=${STATION_NAME}
      - STATION_DESCRIPTION=${STATION_DESCRIPTION}

  bgutil-provider:
    image: brainicism/bgutil-ytdlp-pot-provider
    restart: unless-stopped

  api:
    build: ./api
    restart: unless-stopped
    mem_limit: 600m
    cpus: '0.8'
    depends_on:
      - bgutil-provider
    volumes:
      - media:/media
      - db:/data
      - ./cookies:/app/cookies
    environment:
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - DB_PATH=/data/radio.db
      - MEDIA_DIR=/media
      - STATION_NAME=${STATION_NAME}
      - SERVER_HOSTNAME=${SERVER_HOSTNAME}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - ALERT_FROM=${ALERT_FROM}
      - ALERT_TO=${ALERT_TO}
    expose:
      - "8000"

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    mem_limit: 64m
    logging:
      driver: awslogs
      options:
        awslogs-region: us-west-2
        awslogs-group: /radio/nginx
        awslogs-stream: "${SERVER_HOSTNAME}"
        awslogs-create-group: "true"
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    environment:
      - SERVER_HOSTNAME=${SERVER_HOSTNAME}
      - STATION_NAME=${STATION_NAME}
    labels:
      - "family-radio.service=nginx"
    volumes:
      # .template files are processed by envsubst at container startup
      - ./nginx/default.conf.template:/etc/nginx/templates/default.conf.template:ro
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro
      - ./frontend:/usr/share/nginx/html:ro
      - certbot_www:/var/www/certbot:ro
      - certbot_conf:/etc/letsencrypt:ro

  certbot:
    build: ./certbot
    volumes:
      - certbot_www:/var/www/certbot
      - certbot_conf:/etc/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    entrypoint: >
      sh -c "trap exit TERM; while :; do
        certbot renew --webroot -w /var/www/certbot --quiet
          --deploy-hook 'reload-nginx';
        sleep 12h & wait $${!}; done"

volumes:
  media:
  db:
  certbot_www:
  certbot_conf:
